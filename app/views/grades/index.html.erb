<!--13Apr2013-DEPT UNIT for current user-->
<% @anc_depth = current_user.staff.position.ancestry_depth %>

<!--27May2013-how to retrieve position for staff with multiple positions?-->
<% @multi_position = Position.find(:all, :conditions => ['staff_id=?',current_user.staff_id])%>
<% @ifmulti_position = @multi_position.count %>

<% if @anc_depth==2 %>
	<% @dept_unit = current_user.staff.position.unit %>
<% elsif @anc_depth < 2 %>
	<%# @position_count = Position.find(:all, :conditions=>['staff_id=?',current_user.staff]).count %>
	<%# if @position_count > 1 %>
	<% if @ifmulti_position > 1 %><!--DRY-27 May 2013-->
		<% @dept_unit = Position.find(:first,:conditions=>['staff_id=? and ancestry_depth=?', current_user.staff_id,2]).unit %>			
	<% end %>
	<!--26 May 2013-newly added for Mdm Yap Peck Seah-ancestry_depth-1(Ketua Unit penilaian & Kualiti)-->
	<% if @anc_depth==1 %>
		<% @dept_unit = Position.find(:first,:conditions=>['staff_id=?', current_user.staff_id]).unit %>
	<% end %>
	<!--26 May 2013-newly added for Mdm Yap Peck Seah-ancestry_depth-1(Ketua Unit penilaian & Kualiti)-->
<% elsif @anc_depth > 2 %>
	<!--27 May 2013-START-added for mohd firdaus fikri(radiografi)-MULTIPLE positions-->
	<% if @ifmulti_position > 1 %>
		<% @multi_position.each do |x|%>
			<% if x.parent.id > 6 && x.parent.id < 17 %>
				<!--hoho<%#= @dept_unit = x.parent.unit %>--><% @dept_unit = x.parent.unit %>
			<% end %>	
		<% end %>
	<% else %>
		<% @dept_unit = current_user.staff.position.ancestors.at_depth(2)[0].unit %>
		<!--30Mei2013-->
		<% if @dept_unit == "Pos Basik" && @anc_depth == 3 %><!--@anc_depth==3-->
			<% @dept_unit = current_user.staff.position.unit %>
		<% end %>
		<!--30Mei2013-->
	<% end %>
	<!--27 May 2013-START-added for mohd firdaus fikri(radiografi)-MULTIPLE positions-->
<% end %>

<% current_user_roles=[]%>
<% User.current_user.roles.each do |role|%>
	<% current_user_roles<<role.id%>
<% end %>
<%#= current_user_roles.include?(2)%>
<!--13/20Apr2013-DEPT UNIT for current user-->

<%###################################################%>
<!--existing grade for certain subject-->
<% @existing_grade_subject_ids = Grade.find(:all,:select=>:subject_id).map(&:subject_id).uniq %>

<% if current_user_roles.include?(2) %><!--if administrator-->
	<% if @dept_unit != nil %><!--must also have dept unit(from ancestor-at_depth:2), or NO programme will be pre-selected-->
		<!--26 May 2013-HAVE TO MAKE SURE : position of current logged-in staff is between 7-16 OR line 29 & 30 will FAILED & ERROR-->
		<% if current_user.staff.position.id > 6 && current_user.staff.position.id < 17 %>
			<% @preselect_prog = Programme.find(:first, :conditions=>['name=?',@dept_unit]).id %>
			<% @subjectlist_preselec_prog = Programme.find(@preselect_prog).descendants.at_depth(2) %>
		<% end %>
	<% else %>
		<!--have to assign values for SUBJECT search form for ADMIN-->
		<% @subjectlist_preselec_prog = Programme.at_depth(2) %>
	<% end %>
	<%#=====================3June2013=========================%>
	<% if @existing_grade_subject_idss.count == 0 %>
		<% @grade_list_exist_subject = []%>
	<% else %>
		<% @grade_list_exist_subject = Programme.find(:all, :conditions=>['id IN(?)', @existing_grade_subject_ids]) %>
	<% end %>
	<%#=====================3June2013=========================%>
<% else %>
	<% if @anc_depth==1 %>
	<!--26 May 2013-newly added for Mdm Yap Peck Seah-ancestry_depth-1(Ketua Unit penilaian & Kualiti)-->
		<% @kupk = "yes" %>
		<!--have to assign values for SUBJECT search form for KUPK-->
		<% @subjectlist_preselec_prog = Programme.at_depth(2) %>
		<%#=====================3June2013=========================%>
		<% if @existing_grade_subject_ids.count == 0 %>
			<% @grade_list_exist_subject= []%>
		<% else %>
			<% @grade_list_exist_subject = Programme.find(:all, :conditions=>['id IN(?)', @existing_grade_subject_ids]) %>
		<% end %>
		<%#=====================3June2013=========================%>
	<!--26 May 2013-newly added for Mdm Yap Peck Seah-ancestry_depth-1(Ketua Unit penilaian & Kualiti)-->
	<% else %><%#=@dept_unit%><%#=@anc_depth%>
		<% @preselect_prog = Programme.find(:first, :conditions=>['name=?',@dept_unit]).id %>
		<% @subjectlist_preselec_prog = (Programme.find(@preselect_prog).descendants.at_depth(2)).sort_by{|y|y.code} %>
		<%#=====================3June2013=========================%>
		<% if @existing_grade_subject_ids.count == 0 %>
			<% @grade_list_exist = []%>
		<% else %>
			<% @grade_list_exist_subject = Programme.find(:all, :conditions=>['id IN(?) and id IN(?)', @existing_grade_subject_ids, @subjectlist_preselec_prog]) %>
		<% end %>
		<%#=====================3June2013=========================%>
	<% end %>
<% end %>
	
	
<!---->

<!-- Box -->
<div class="box">
	<!-- Box Head -->
	<div class="box-head">
		<h2 class="left">Lists of Grades</h2>
	</div>
</div>

<div class="toolbar">	
	<p><%= link_to image_tag("add.png", :border => 0, :title => 'New Grade') + "New", new_grade_path(:new_type => "0") %></p>
</div>
<div class="right">
	<% form_tag :action => 'new' do %>
		<%= hidden_field_tag( "new_type","3" )%>
		<b>Subject : </b><%= select_tag('subjectid', options_from_collection_for_select(@subjectlist_preselec_prog, :id, :subject_list)) %>
		<%#= select_tag('subjectid', "<option value='0'>Select Exam Paper</option>" + options_from_collection_for_select(Exam.all, :id, :exam_code_date)) %>
		<%= submit_tag 'New Multiple Grades', :subject_id => nil %>
	<% end %>
</div>
<br><br>

<div class="right" style="text-align:right;">
&nbsp;&nbsp;<font size=-2 color=blue> <b>Total Formative</b> = Sum of scores, <b>CA+MSE</b> = Total Formative*(100-summative weightage)/100
	<br><b>Total Summative</b> = (Final Exam * summative weightage) / 100, <b>Total Marks</b> = CA+MSE + Total Summative</font>
</div>
<br><br>
<div class="tlist">
	
	<!-- 3June2013 -->
	<% form_tag edit_multiple_grades_path, :id => "form1" do %>
	<!-- 3June2013 -->
	
	 <table width=100% border="0" cellpadding="0" cellspacing="0">
<tr>
	<th>&nbsp;</th><!--3June2013-->
    <th>Student</th>
    <th>Subject</th>
   	<!--<th>Sent to bpl</th>-->
    <th>Sent date</th>
    <th>Total Formative</th>
	<th>CA+MSE</th>
	<th style="text-align:center;"width=70px>Summative Weightage</th>
    <!--<th>Score</th>-->
    <!--<th>Eligible for Exam</th>-->
    <!--<th>Carry Paper</th>-->
	<th>Final Exam</th>
    <th style="text-align:center;"width=70px>Total Summative</th>
    <!--<th>Resit</th>-->
    <th>Total Marks</th>
    <th>Grade</th>
    <th colspan=3 class="ac">Control</th>
</tr>
<% @grades_group.each do |grades_group, grades| %>
<%# grades.each do |grade| %><!--@grades.sort_by{|x|x.studentgrade.name}-->

<% grades.sort_by{|x|x.studentgrade.name}.each_with_index do |grade,index|%>
 <% if (@dept_unit==grade.subjectgrade.root.name) ||(current_user_roles.include?(2))||@kupk == "yes" %><!--STAND BY:HIDE THIS LINE & LINE 67 to view ALL GRADES-->
		<% if index == 0%>
		<tr><td colspan=14 style="background-color:#EFF1F1;"><b>Subject : <%=h Programme.find(grades_group).subject_list %></b></td></tr>
		<% end %>
  <tr>
	<td><%= check_box_tag "grade_ids[]", grade.id, :class => "check" %></td><!-- 3June2013-->
    <td><%=h grade.student_id.blank? ? "" : grade.studentgrade.matrix_name %></td>
    <td><%=h grade.subject_id.blank? ? "" : grade.subjectgrade.subject_list %></td>
    <!-- <td><%=h grade.sent_to_BPL %></td>-->
    <td><%=h grade.sent_date %></td>
    <td style="text-align:center;"><%=grade.total_formative %> | <%=h grade.formative %></td>
	<td style="text-align:center;"><%=grade.ca_plus_mse%></td>
	<td style="text-align:center;"><%=grade.examweight%>&nbsp;%</td> 
	<td style="text-align:center;"><%= grade.exam1marks %></td>
    <!--<td><%=h grade.score %></td>-->
    <!--<td><%=h grade.eligible_for_exam %></td>
    <td><%=h grade.carry_paper %></td>-->
    <td style="text-align:center;"><%#=h grade.summative %><%=grade.total_summative %></td>
    <!--<td><%=h grade.resit %></td>-->
    <td style="text-align:center;"><%#=h grade.finalscore %> <%=h grade.finale %></td>
    <td><%#=h (Grade::GRADE.find_all{|disp, value| value == grade.grading_id.to_s}).map {|disp, value| disp} %>
	<%=h grade.set_gred %></td>
    <td width=10px ><%= link_to image_tag("document.png", :border => 0), :action => 'show', :id => grade %></td>
    <td width=10px><%= link_to image_tag("edit.png", :border => 0), :action => 'edit', :id => grade %></td>
    <td width=10px><%= link_to image_tag("delete.png", :border => 0, :title => 'Delete'), grade, :confirm => 'Are you sure?', :method => :delete %></td>
  </tr>
	<% end %> <!--HIDE THIS LINE & LINE 49 to view ALL GRADES-->
<% end %>
<% end %><!--end for @grades_group.each do |grades_group, grades| -->
</table>
</div>
<br />

<!--for multiple edit-3June2013-->
<div class="left">
<!-- ref: http://railsforum.com/viewtopic.php?id=2151 rleblic2007-10-25 08:43:07 -->
<!--http://www.ryboe.com/2008/07/10/select-all-checkboxes-with-prototype-js.html -->
<input id="check_all" name="check_all" type="checkbox" checked="checked" onclick="
Form.getInputs('form1', 'checkbox').each(function(box){box.checked = $('check_all').checked})" />
<b>Check/Uncheck 				all</b>&nbsp;&nbsp;
</div>

<!-- 15 -22 May 2012 -->
<%= submit_tag "Edit Checked", :name => :grade_submit_button %>
<%#= submit_tag "Edit by Exam", :name => :exammark_submit_button %>
<% end %>
<!-- 15 - 22May 2012 -->
	
<!--for multiple edit-3June2013-->

<div class="right">
	<% form_tag '', :method => 'get' do %>
		<b>Subject : </b><%= select_tag('subject_id', "<option value='0'>All Existing Grades</option>" +options_from_collection_for_select(@grade_list_exist_subject, :id, :subject_list)) %>
		<%= submit_tag 'Search Existing Grades', :name => :grade_search %>
	<% end %>
</div>



<%#= link_to 'New Grade', new_grade_path %> <!--10Apr2013-->
<%= link_to 'New Grade', new_grade_path(:new_type => "0")%>
<%#= link_to 'Multiple New Grades', new_grade_path(:new_type => "2") %>