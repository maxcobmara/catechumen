<%=render :partial => 'exams/position_dept' %> <!--retrieve position for current logged-in user-->
<div class="box">
	<div class="box-head">
		<h2 class="left">Student Attendance List</h2>
			<div class="right">
	    	<%# form_tag books_path, :method => 'get' do %>
				<%#= text_field_tag :search, params[:search], :placeholder => "ISBN, Title, Author, Location" %>
				<%#= submit_tag "Search", :title => nil %>
			<%# end %><%=@dept_unit%><%=@preselect_prog%>
			</div>
	</div>
</div>

<div class="toolbar">
	<p><%= link_to image_tag("add.png", :border => 0, :title => 'New Student Attendance') + "New", new_student_attendance_path(:new_type => "1") %></p>
</div>

<br><br>
<% @intake_list = Student.find(:all, :conditions => ['course_id=?',@preselect_prog]).map(&:intake).uniq %>
<div class="left">
	<% form_tag :action => 'new' do %>
		<%= hidden_field_tag( "new_type","3" )%>
		<b>Intake : </b><%= select_tag('intake', options_for_select(@intake_list.sort)) %>
		<%= submit_tag 'Multiple Attendance by Intake', :subject_id => nil %>
	<% end %>
</div>

<% @topics_ids_this_prog = Programme.find(@preselect_prog).descendants.at_depth(3).map(&:id) %>
<% @schedule_list = WeeklytimetableDetail.find(:all, :conditions => ['topic IN(?)',@topics_ids_this_prog])%>
<div class="right">
	<% form_tag :action => 'new' do %>
		<%= hidden_field_tag( "new_type","2" )%>
		<b>Class / Schedule : </b><%= select_tag('classid', options_from_collection_for_select(@schedule_list, :id, :subject_day_time)) %>
		<%= submit_tag 'Multiple Attendance by Schedule', :subject_id => nil %>
	<% end %>
</div>
<br><br>

<div class="tlist">
	
	<% form_tag edit_multiple_student_attendances_path, :id => "form1" do %>
	
	<table width=100% border="0" cellpadding="0" cellspacing="0">
  	<tr>
		<th>&nbsp;</th>
    	<th>Student</th>
		<th>Attend</th>
		<th colspan=3>Control</th>
  	</tr>

	<% @student_attendances_class.each do |class_session, student_attendances|%>
		<tr>
			<td colspan=8 style="background-color:#EFF1F1;">
				<% unless student_attendances[0].weeklytimetable_details_id.blank? || student_attendances[0].weeklytimetable_details_id.nil? %>
					<!--start:with weeklytimetable_details_id existance-->
					<span style="font-weight:bold;">
						Subject : <%=h student_attendances[0].weeklytimetable_detail.weeklytimetable_topic.full_parent %> | 
						Topic : <%=h student_attendances[0].weeklytimetable_detail.weeklytimetable_topic.subject_list %><%#=class_session %>
					</span><br>
					Date : <%=h student_attendances[0].weeklytimetable_detail.get_date_day_of_schedule %> |
					Time : 
					<% if student_attendances[0].weeklytimetable_detail.time_slot==0 %>
						<%=TimetablePeriod.find(student_attendances[0].weeklytimetable_detail.time_slot2).timing %>				
					<% else %>
						<%=TimetablePeriod.find(student_attendances[0].weeklytimetable_detail.time_slot).timing %>
					<% end %> |
					Lecturer : <%=h student_attendances[0].weeklytimetable_detail.weeklytimetable_lecturer.name %> |
					Intake : <%=h student_attendances[0].weeklytimetable_detail.weeklytimetable.schedule_intake.name %>
					(<%= (WeeklytimetableDetail::CLASS_METHOD.find_all{|disp, value| value == student_attendances[0].weeklytimetable_detail.lecture_method}).map {|disp, value| disp}%>)
					<!--end:with weeklytimetable_details_id existance-->
				<% else %>	
					<!--start-display intakes only-->
					<!--end-display intakes only-->
				<% end %>
			</td>
		</tr>
		<% student_attendances.each do |student_attendance| %>
  		<tr>
			<td><%= check_box_tag "student_attendance_ids[]", student_attendance.id, :class => "check" %></td>
    		<td><%=h student_attendance.student.matrix_name %></td>
			<td><% if student_attendance.attend == true %> &#10003;<% end %></td>
			<td width=10px><%= link_to image_tag("document.png",:border => 0, :title => 'Show'), :action => 'show', :id => student_attendance %></td>
			<td width=10px><%= link_to image_tag("edit.png",:border => 0, :title => 'Edit'),:action => 'edit', :id => student_attendance %></td>
			<td width=10px ><%= link_to image_tag("delete.png",:border => 0, :title => 'Delete'), student_attendance,:confirm => 'Are you sure?',:method => :delete %></td>
		</tr>
		<% end %>
		
	<% end %>
	
	</table>
	<br><br>
	
	<div class="left">
		<!-- ref: http://railsforum.com/viewtopic.php?id=2151 rleblic2007-10-25 08:43:07 -->
		<!--http://www.ryboe.com/2008/07/10/select-all-checkboxes-with-prototype-js.html -->
		<input id="check_all" name="check_all" type="checkbox" checked="checked" onclick="Form.getInputs('form1', 'checkbox').each(function(box){box.checked = $('check_all').checked})" />
		<b>Check/Uncheck all</b>&nbsp;&nbsp;
	</div>

	<%= submit_tag "Edit Checked", :name => :student_attendance_submit_button %>
	<% end %><!--end for form-->

</div>

<% @exist_attendances = StudentAttendance.all.map(&:weeklytimetable_details_id).uniq %>
<% @exist_timetable_attendances = WeeklytimetableDetail.find(:all, :conditions=>['id IN (?)', @exist_attendances])%>

<div class="right">
	<% form_tag '', :method => 'get' do %>
		<b>Class / Schedule : </b><%= select_tag('classid', "<option value='0'>All Existing Staff Attendance</option>" +options_from_collection_for_select(@exist_timetable_attendances, :id, :subject_day_time)) %><!--WeeklytimetableDetail.all, :id, :subject_day_time-->
		<%= submit_tag 'Search Staff Attendances', :name => :exammark_search %>
	<% end %>
</div>
<br />

<%= link_to 'New student attendance', new_student_attendance_path %>